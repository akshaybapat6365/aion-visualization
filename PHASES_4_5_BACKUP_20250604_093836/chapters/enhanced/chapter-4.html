<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 4: The Sign of the Fishes - Aion Visualization</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="responsive-utils.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="webgl-utils.js"></script>
    <script src="error-boundaries.js"></script>
    <script src="accessibility-utils.js"></script>
    <script src="progress-tracker.js"></script>
    <script src="visualization-loader.js"></script>
    <script src="apply-fixes.js" defer></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="../../index.html" class="nav-link">Home</a>
            <a href="chapters.html" class="nav-link">Chapters</a>
            <a href="timeline.html" class="nav-link">Timeline</a>
            <a href="symbols.html" class="nav-link">Symbols</a>
            <a href="about.html" class="nav-link">About</a>
        </div>
    </nav>

    <main class="chapter-content">
        <div class="chapter-header">
            <div class="chapter-number">Chapter IV</div>
            <h1 class="chapter-title">The Sign of the Fishes</h1>
            <p class="chapter-subtitle">Astrological Symbolism of the Pisces Age</p>
        </div>

        <section class="chapter-intro">
            <p>Jung explores the astrological significance of the Pisces constellation, whose two fish swimming in opposite directions symbolize the fundamental duality of the Christian aeon. This chapter examines the 2,160-year transition from the Age of Aries to Pisces, and the approaching shift to Aquarius.</p>
        </section>

        <!-- Enhanced Astrological Clock -->
        <section class="visualization-section">
            <h2>The Great Astrological Clock</h2>
            <div class="visualization-intro">
                <p>Experience the 26,000-year cycle of precession. Each astrological age lasts approximately 2,160 years. Watch the transition from Aries (Ram) to Pisces (Fish) to Aquarius (Water Bearer).</p>
            </div>
            <div id="astrological-clock" class="visualization-container"></div>
            <div class="visualization-controls">
                <div class="control-group">
                    <label for="time-slider">Time Span:</label>
                    <input type="range" id="time-slider" min="-4000" max="4000" value="0" step="50">
                    <span id="current-year">0 CE</span>
                </div>
                <div class="control-group">
                    <button id="play-precession">Play Precession</button>
                    <button id="pause-precession">Pause</button>
                    <button id="reset-precession">Reset</button>
                </div>
                <div class="control-group">
                    <label for="speed-control">Speed:</label>
                    <select id="speed-control">
                        <option value="0.5">Slow</option>
                        <option value="1" selected>Normal</option>
                        <option value="2">Fast</option>
                        <option value="5">Very Fast</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Fish Duality Visualization -->
        <section class="visualization-section">
            <h2>The Dual Fish: Opposition in Unity</h2>
            <div class="visualization-intro">
                <p>The two fish of Pisces swim in opposite directions, representing the eternal tension between spirit and matter, Christ and Antichrist, conscious and unconscious.</p>
            </div>
            <div id="fish-duality" class="visualization-container"></div>
            <div class="visualization-controls">
                <button id="toggle-fish-animation">Toggle Animation</button>
                <button id="show-symbolic-meaning">Show Symbolic Meaning</button>
                <button id="highlight-opposition">Highlight Opposition</button>
            </div>
        </section>

        <!-- Constellation Viewer -->
        <section class="visualization-section">
            <h2>Interactive Constellation Viewer</h2>
            <div class="visualization-intro">
                <p>Explore the actual constellations and their mythological significance. See how the stars appear to move due to Earth's axial precession.</p>
            </div>
            <div id="constellation-viewer" class="visualization-container"></div>
            <div class="visualization-controls">
                <button id="show-constellation-lines">Toggle Constellation Lines</button>
                <button id="show-mythology">Show Mythology</button>
                <button id="toggle-precession-motion">Toggle Precession Motion</button>
                <select id="constellation-select">
                    <option value="pisces">Pisces (Current)</option>
                    <option value="aries">Aries (Previous)</option>
                    <option value="aquarius">Aquarius (Next)</option>
                </select>
            </div>
        </section>

        <!-- Historical Timeline -->
        <section class="visualization-section">
            <h2>Historical Manifestations</h2>
            <div class="visualization-intro">
                <p>See how the transition between astrological ages manifests in historical events, religious movements, and cultural shifts.</p>
            </div>
            <div id="historical-timeline" class="visualization-container"></div>
            <div class="timeline-controls">
                <button id="filter-religious">Religious Events</button>
                <button id="filter-cultural">Cultural Shifts</button>
                <button id="filter-symbolic">Symbolic Changes</button>
                <button id="show-all-events">Show All</button>
            </div>
        </section>

        <!-- Educational Content -->
        <section class="content-section">
            <h2>The Psychological Significance</h2>
            <div class="concept-grid">
                <div class="concept-card">
                    <h3>Aries Age (2000 BCE - 0 CE)</h3>
                    <ul>
                        <li>Ram symbolism in Judaism</li>
                        <li>Abraham's sacrifice</li>
                        <li>Moses and the golden calf</li>
                        <li>Warrior consciousness</li>
                    </ul>
                </div>
                <div class="concept-card">
                    <h3>Pisces Age (0 - 2000 CE)</h3>
                    <ul>
                        <li>Fish symbolism in Christianity</li>
                        <li>Duality of Christ/Antichrist</li>
                        <li>Oceanic consciousness</li>
                        <li>Faith over knowledge</li>
                    </ul>
                </div>
                <div class="concept-card">
                    <h3>Aquarius Age (2000+ CE)</h3>
                    <ul>
                        <li>Water bearer symbolism</li>
                        <li>Consciousness transformation</li>
                        <li>Integration of opposites</li>
                        <li>Scientific spirituality</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Navigation -->
        <div class="chapter-nav">
            <a href="chapter3.html" class="prev-chapter">← Chapter 3: The Syzygy</a>
            <a href="chapter5.html" class="next-chapter">Chapter 5: Christ as Archetype →</a>
        </div>
    </main>

    <style>
        .visualization-container {
            position: relative;
            height: 600px;
            background: var(--surface-glass);
            border-radius: 1rem;
            overflow: hidden;
            margin: 2rem 0;
        }

        .visualization-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--surface-glass);
            border-radius: 0.5rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .control-group input, .control-group select {
            padding: 0.5rem;
            background: var(--surface-secondary);
            border: 1px solid var(--border-default);
            border-radius: 0.25rem;
            color: var(--text-primary);
        }

        .control-group button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-group button:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        #current-year {
            font-weight: bold;
            color: var(--accent);
            min-width: 80px;
            text-align: center;
        }

        .timeline-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .timeline-controls button {
            padding: 0.5rem 1rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-controls button:hover,
        .timeline-controls button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .constellation-info {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.875rem;
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .constellation-info.visible {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .visualization-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                justify-content: space-between;
            }

            .timeline-controls {
                flex-wrap: wrap;
            }
        }
    </style>

    <script>
        // Initialize visualization loader
        const vizLoader = new VisualizationLoader();
        
        // Enhanced Astrological Clock
        vizLoader.lazyLoad('astrological-clock', function(container) {
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            
            // Create main SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create Three.js scene for 3D clock
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(width, height);
            renderer.setClearColor(0x000000, 0);
            
            // Add accessibility attributes to canvas
            renderer.domElement.setAttribute('role', 'img');
            renderer.domElement.setAttribute('aria-label', 'Interactive 3D astrological clock showing the precession of equinoxes and zodiac ages');
            renderer.domElement.setAttribute('tabindex', '0');
            
            container.appendChild(renderer.domElement);
            
            // Add detailed description for screen readers
            const description = document.createElement('div');
            description.id = 'astrological-clock-description';
            description.className = 'sr-only';
            description.innerHTML = `
                <h3>Astrological Clock Description</h3>
                <p>This visualization shows a 3D representation of the zodiac wheel and astrological ages caused by the precession of equinoxes. The Earth's axis slowly wobbles over approximately 26,000 years, causing the zodiac constellations to appear to shift backward through the seasons.</p>
                <p>Current display shows the transition from the Pisces Age (Christianity, fish symbolism) to the Aquarius Age. Each zodiac sign corresponds to roughly 2,160 years of human history.</p>
                <p>Use the controls below the visualization to adjust the timeline and see how different astrological ages correspond to major shifts in human consciousness and civilization.</p>
            `;
            container.appendChild(description);
            renderer.domElement.setAttribute('aria-describedby', 'astrological-clock-description');

            // Position camera
            camera.position.set(0, 0, 10);

            // Create zodiac wheel
            const zodiacSigns = [
                { name: 'Aries', symbol: '♈', angle: 0, color: 0xFF4444, age: { start: -2000, end: 0 } },
                { name: 'Pisces', symbol: '♓', angle: 30, color: 0x4444FF, age: { start: 0, end: 2160 } },
                { name: 'Aquarius', symbol: '♒', angle: 60, color: 0x44FFFF, age: { start: 2160, end: 4320 } },
                { name: 'Capricorn', symbol: '♑', angle: 90, color: 0x44FF44, age: { start: 4320, end: 6480 } },
                { name: 'Sagittarius', symbol: '♐', angle: 120, color: 0xFFFF44, age: { start: 6480, end: 8640 } },
                { name: 'Scorpio', symbol: '♏', angle: 150, color: 0xFF44FF, age: { start: 8640, end: 10800 } },
                { name: 'Libra', symbol: '♎', angle: 180, color: 0x44FFAA, age: { start: 10800, end: 12960 } },
                { name: 'Virgo', symbol: '♍', angle: 210, color: 0xAA44FF, age: { start: 12960, end: 15120 } },
                { name: 'Leo', symbol: '♌', angle: 240, color: 0xFFAA44, age: { start: 15120, end: 17280 } },
                { name: 'Cancer', symbol: '♋', angle: 270, color: 0x44AAFF, age: { start: 17280, end: 19440 } },
                { name: 'Gemini', symbol: '♊', angle: 300, color: 0xAAFF44, age: { start: 19440, end: 21600 } },
                { name: 'Taurus', symbol: '♉', angle: 330, color: 0xFF44AA, age: { start: 21600, end: 23760 } }
            ];

            // Create zodiac wheel geometry
            const wheelGroup = new THREE.Group();
            const wheelRadius = 5;

            // Create segments
            zodiacSigns.forEach((sign, index) => {
                const geometry = new THREE.RingGeometry(wheelRadius - 0.5, wheelRadius, 
                    index * Math.PI / 6, Math.PI / 6, 32);
                const material = new THREE.MeshBasicMaterial({ 
                    color: sign.color, 
                    transparent: true, 
                    opacity: 0.3,
                    side: THREE.DoubleSide
                });
                const segment = new THREE.Mesh(geometry, material);
                wheelGroup.add(segment);

                // Add sign symbols
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 128;
                canvas.height = 128;
                context.fillStyle = `#${sign.color.toString(16).padStart(6, '0')}`;
                context.font = '72px Arial';
                context.textAlign = 'center';
                context.fillText(sign.symbol, 64, 80);

                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                
                const angle = (index * 30 - 90) * Math.PI / 180;
                sprite.position.set(
                    Math.cos(angle) * (wheelRadius - 0.25),
                    Math.sin(angle) * (wheelRadius - 0.25),
                    0.1
                );
                sprite.scale.set(0.8, 0.8, 1);
                wheelGroup.add(sprite);
            });

            scene.add(wheelGroup);

            // Create Earth pointer
            const pointerGeometry = new THREE.ConeGeometry(0.1, 0.5, 8);
            const pointerMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
            const pointer = new THREE.Mesh(pointerGeometry, pointerMaterial);
            pointer.position.set(0, 0, 0.2);
            pointer.rotation.z = Math.PI;
            scene.add(pointer);

            // Animation variables
            let isPlaying = false;
            let currentYear = 0;
            let speed = 1;

            function updateClock(year) {
                currentYear = year;
                
                // Calculate precession angle (backwards due to precession)
                const precessionAngle = -(year / 25920) * 2 * Math.PI;
                wheelGroup.rotation.z = precessionAngle;

                // Update year display
                document.getElementById('current-year').textContent = 
                    year < 0 ? `${Math.abs(year)} BCE` : `${year} CE`;

                // Update time slider
                document.getElementById('time-slider').value = year;

                // Highlight current age
                const currentAge = zodiacSigns.find(sign => 
                    year >= sign.age.start && year < sign.age.end);
                
                if (currentAge) {
                    // Update constellation info
                    updateConstellationInfo(currentAge, year);
                }
            }

            function updateConstellationInfo(currentAge, year) {
                const progress = ((year - currentAge.age.start) / 
                    (currentAge.age.end - currentAge.age.start)) * 100;
                
                // You could add an info panel here
                console.log(`Current Age: ${currentAge.name} (${progress.toFixed(1)}% complete)`);
            }

            // Animation loop
            function animate() {
                if (isPlaying) {
                    currentYear += speed * 10; // 10 years per frame
                    if (currentYear > 4000) currentYear = -4000;
                    updateClock(currentYear);
                }
                
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }

            // Controls
            document.getElementById('time-slider').addEventListener('input', (e) => {
                updateClock(parseInt(e.target.value));
            });

            document.getElementById('play-precession').addEventListener('click', () => {
                isPlaying = true;
            });

            document.getElementById('pause-precession').addEventListener('click', () => {
                isPlaying = false;
            });

            document.getElementById('reset-precession').addEventListener('click', () => {
                isPlaying = false;
                updateClock(0);
            });

            document.getElementById('speed-control').addEventListener('change', (e) => {
                speed = parseFloat(e.target.value);
            });

            // Handle resize
            window.addEventListener('resize', () => {
                const newWidth = container.offsetWidth;
                const newHeight = container.offsetHeight;
                camera.aspect = newWidth / newHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(newWidth, newHeight);
            });

            // Initialize
            updateClock(0);
            animate();
        });

        // Fish Duality Visualization
        vizLoader.lazyLoad('fish-duality', function(container) {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            renderer.setClearColor(0x000000, 0);
            container.appendChild(renderer.domElement);

            camera.position.set(0, 0, 8);

            // Create fish shapes using curves
            function createFishCurve(direction = 1) {
                const curve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(-2 * direction, 0, 0),
                    new THREE.Vector3(-1 * direction, 0.5 * direction, 0),
                    new THREE.Vector3(0, 0, 0),
                    new THREE.Vector3(1 * direction, -0.5 * direction, 0),
                    new THREE.Vector3(2 * direction, 0, 0),
                ]);
                return curve;
            }

            // Create first fish (Christ - upward)
            const fish1Curve = createFishCurve(1);
            const fish1Geometry = new THREE.TubeGeometry(fish1Curve, 64, 0.1, 8, false);
            const fish1Material = new THREE.MeshBasicMaterial({ 
                color: 0xFFD700, 
                transparent: true, 
                opacity: 0.8 
            });
            const fish1 = new THREE.Mesh(fish1Geometry, fish1Material);
            fish1.position.set(0, 1, 0);
            scene.add(fish1);

            // Create second fish (Antichrist - downward)
            const fish2Curve = createFishCurve(-1);
            const fish2Geometry = new THREE.TubeGeometry(fish2Curve, 64, 0.1, 8, false);
            const fish2Material = new THREE.MeshBasicMaterial({ 
                color: 0x6B46C1, 
                transparent: true, 
                opacity: 0.8 
            });
            const fish2 = new THREE.Mesh(fish2Geometry, fish2Material);
            fish2.position.set(0, -1, 0);
            fish2.rotation.z = Math.PI;
            scene.add(fish2);

            // Add connecting line
            const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 1, 0),
                new THREE.Vector3(0, -1, 0)
            ]);
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0xFFFFFF, 
                transparent: true, 
                opacity: 0.5 
            });
            const line = new THREE.Line(lineGeometry, lineMaterial);
            scene.add(line);

            // Animation
            let animationEnabled = true;
            function animate() {
                if (animationEnabled) {
                    const time = Date.now() * 0.001;
                    fish1.rotation.y = time * 0.5;
                    fish2.rotation.y = -time * 0.5;
                }
                
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }

            // Controls
            document.getElementById('toggle-fish-animation').addEventListener('click', () => {
                animationEnabled = !animationEnabled;
            });

            document.getElementById('show-symbolic-meaning').addEventListener('click', () => {
                // Toggle symbolic overlay
                const overlay = document.querySelector('.symbolic-overlay');
                if (overlay) {
                    overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
                }
            });

            document.getElementById('highlight-opposition').addEventListener('click', () => {
                // Highlight the opposition
                fish1Material.color.setHex(0xFF0000);
                fish2Material.color.setHex(0x0000FF);
                setTimeout(() => {
                    fish1Material.color.setHex(0xFFD700);
                    fish2Material.color.setHex(0x6B46C1);
                }, 2000);
            });

            animate();
        });

        // Historical Timeline
        vizLoader.lazyLoad('historical-timeline', function(container) {
            const margin = { top: 40, right: 40, bottom: 60, left: 60 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', container.offsetWidth)
                .attr('height', 400);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Historical events data
            const events = [
                { year: -2000, event: "Abraham's Journey", type: "religious", significance: "Transition from bull to ram worship" },
                { year: -1500, event: "Moses & Golden Calf", type: "religious", significance: "Rejection of Taurus age symbols" },
                { year: -600, event: "Buddha's Enlightenment", type: "religious", significance: "Eastern spiritual awakening" },
                { year: 0, event: "Birth of Christ", type: "religious", significance: "Beginning of Pisces age" },
                { year: 33, event: "Crucifixion", type: "religious", significance: "Fish symbol adopted by Christians" },
                { year: 325, event: "Council of Nicaea", type: "religious", significance: "Christianity becomes institutional" },
                { year: 1000, event: "Expected Apocalypse", type: "cultural", significance: "Midpoint millennium fears" },
                { year: 1517, event: "Protestant Reformation", type: "religious", significance: "Religious authority questioned" },
                { year: 1900, event: "Psychology Emerges", type: "cultural", significance: "Unconscious mind discovered" },
                { year: 1945, event: "Atomic Age", type: "symbolic", significance: "Shadow projection reaches global scale" },
                { year: 2000, event: "Millennium", type: "symbolic", significance: "Transition to Aquarius begins?" }
            ];

            // Scales
            const xScale = d3.scaleLinear()
                .domain([-2200, 2200])
                .range([0, width]);

            const colorScale = d3.scaleOrdinal()
                .domain(['religious', 'cultural', 'symbolic'])
                .range(['#FFD700', '#6B46C1', '#4A90E2']);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => d < 0 ? `${Math.abs(d)} BCE` : `${d} CE`));

            // Add events
            const eventGroups = g.selectAll('.event')
                .data(events)
                .enter().append('g')
                .attr('class', 'event')
                .attr('transform', d => `translate(${xScale(d.year)},${height/2})`);

            eventGroups.append('circle')
                .attr('r', 8)
                .attr('fill', d => colorScale(d.type))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);

            eventGroups.append('text')
                .attr('y', -15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '10px')
                .text(d => d.event);

            // Add timeline controls functionality
            document.querySelectorAll('.timeline-controls button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.timeline-controls button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.id.replace('filter-', '').replace('show-all-events', 'all');
                    
                    eventGroups.style('opacity', d => {
                        if (filter === 'all') return 1;
                        return d.type === filter ? 1 : 0.3;
                    });
                });
            });
        });

    </script>
</body>
</html>