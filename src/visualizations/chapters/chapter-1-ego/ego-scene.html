<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 1: The Ego - Aion Visualization</title>
    
    <!-- Design System -->
    <link rel="stylesheet" href="../../../design-system/core/reset.css">
    <link rel="stylesheet" href="../../../design-system/core/colors.css">
    <link rel="stylesheet" href="../../../design-system/core/typography.css">
    <link rel="stylesheet" href="../../../design-system/core/spacing.css">
    <link rel="stylesheet" href="../../../design-system/core/layout.css">
    
    <style>
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-primary);
            margin: 0;
            overflow: hidden;
        }
        
        #visualization-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .chapter-header {
            position: absolute;
            top: var(--space-8);
            left: var(--space-8);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: var(--space-6) var(--space-8);
            border-radius: 4px;
            pointer-events: auto;
        }
        
        .chapter-number {
            font-size: var(--text-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
        
        .chapter-title {
            font-size: var(--text-size-h2);
            font-weight: 300;
            margin: 0;
        }
        
        .content-panel {
            position: absolute;
            right: 0;
            top: 0;
            width: 400px;
            height: 100%;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            padding: var(--space-8);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.5s ease;
            pointer-events: auto;
        }
        
        .content-panel.active {
            transform: translateX(0);
        }
        
        .content-text {
            font-size: var(--text-size-body);
            line-height: 1.8;
            color: var(--text-primary);
        }
        
        .content-text p {
            margin-bottom: var(--space-6);
        }
        
        .quote {
            font-style: italic;
            color: var(--text-secondary);
            border-left: 2px solid var(--border-strong);
            padding-left: var(--space-4);
            margin: var(--space-8) 0;
        }
        
        .controls {
            position: absolute;
            bottom: var(--space-8);
            left: var(--space-8);
            display: flex;
            gap: var(--space-4);
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: var(--space-3) var(--space-6);
            font-size: var(--text-size-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-primary);
        }
        
        .control-btn:hover {
            background: rgba(26, 26, 26, 0.8);
            border-color: var(--border-strong);
        }
        
        .control-btn.active {
            background: var(--surface-secondary);
            border-color: var(--text-secondary);
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 1s ease;
        }
        
        .loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-text {
            font-size: var(--text-size-h3);
            font-weight: 300;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .info-panel {
            position: absolute;
            bottom: var(--space-8);
            right: var(--space-8);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: var(--space-4);
            font-size: var(--text-size-xs);
            color: var(--text-secondary);
            pointer-events: auto;
        }
        
        @media (max-width: 768px) {
            .content-panel {
                width: 100%;
            }
            
            .chapter-header {
                top: var(--space-4);
                left: var(--space-4);
                padding: var(--space-4) var(--space-6);
            }
            
            .controls {
                bottom: var(--space-4);
                left: var(--space-4);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading">
        <div class="loading-text">Initializing Consciousness...</div>
    </div>
    
    <!-- 3D Visualization Container -->
    <div id="visualization-container"></div>
    
    <!-- Content Overlay -->
    <div id="content-overlay">
        <!-- Chapter Header -->
        <div class="chapter-header">
            <div class="chapter-number">CHAPTER I</div>
            <h1 class="chapter-title">The Ego</h1>
        </div>
        
        <!-- Content Panel -->
        <div class="content-panel" id="content-panel">
            <div class="content-text">
                <p>
                    The ego, according to Jung, is the center of consciousness. It represents 
                    the individual's sense of personal identity and continuity. Like a sphere 
                    containing streams of thought and memory, the ego maintains the coherence 
                    of our conscious experience.
                </p>
                
                <div class="quote">
                    "The ego is a complex of ideas which constitutes the center of the field 
                    of consciousness and appears to possess a high degree of continuity and identity."
                    <br>— C.G. Jung
                </div>
                
                <p>
                    In this visualization, the transparent sphere represents the boundaries of 
                    conscious awareness. The glowing core symbolizes the central organizing 
                    principle of the ego, while the flowing streams represent the continuous 
                    flow of thoughts, perceptions, and memories that constitute our conscious 
                    experience.
                </p>
                
                <p>
                    The memory nodes scattered throughout the sphere represent significant 
                    experiences and knowledge that the ego can access. Notice how they pulse 
                    and connect to the core, showing the dynamic relationship between the 
                    ego and its contents.
                </p>
                
                <p>
                    The particle streams flowing upward symbolize the constant stream of 
                    consciousness—thoughts arising, transforming, and dissipating in an 
                    endless cycle. This represents the temporal nature of conscious experience 
                    and the ego's role in maintaining continuity despite constant change.
                </p>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button class="control-btn" id="toggle-content">Show Text</button>
            <button class="control-btn" id="toggle-rotation">Auto Rotate</button>
            <button class="control-btn" id="reset-view">Reset View</button>
            <button class="control-btn" id="performance">Performance</button>
        </div>
        
        <!-- Info Panel -->
        <div class="info-panel">
            <div>Click and drag to rotate • Scroll to zoom • Press R to reset</div>
        </div>
    </div>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Visualization Scripts -->
    <script type="module">
        import { SceneManager } from '../../core/scene-manager.js';
        import { EgoSphere } from './ego-sphere.js';
        import { ConsciousnessFlow } from './consciousness-flow.js';
        
        // Initialize scene
        const container = document.getElementById('visualization-container');
        const sceneManager = new SceneManager(container);
        
        // Store in window for performance monitor access
        window.performanceMonitor = sceneManager.performanceMonitor;
        
        // Create visualizations
        const egoSphere = new EgoSphere(sceneManager.scene);
        const consciousnessFlow = new ConsciousnessFlow(sceneManager.scene, {
            particleCount: 800,
            flowRadius: 2.5,
            flowHeight: 6
        });
        
        // Position camera
        sceneManager.camera.position.set(0, 2, 8);
        sceneManager.cameraController.controls.target.set(0, 0, 0);
        
        // Add ambient light
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
        sceneManager.add(ambientLight);
        
        // Add point lights
        const light1 = new THREE.PointLight(0xffffff, 0.5);
        light1.position.set(5, 5, 5);
        sceneManager.add(light1);
        
        const light2 = new THREE.PointLight(0xffffff, 0.3);
        light2.position.set(-5, -5, -5);
        sceneManager.add(light2);
        
        // Animation loop
        let lastTime = 0;
        sceneManager.onRender(() => {
            const currentTime = performance.now() * 0.001;
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // Update visualizations
            egoSphere.update(deltaTime);
            consciousnessFlow.update(deltaTime);
        });
        
        // Controls
        const contentPanel = document.getElementById('content-panel');
        const toggleContent = document.getElementById('toggle-content');
        const toggleRotation = document.getElementById('toggle-rotation');
        const resetView = document.getElementById('reset-view');
        const performanceBtn = document.getElementById('performance');
        
        toggleContent.addEventListener('click', () => {
            contentPanel.classList.toggle('active');
            toggleContent.textContent = contentPanel.classList.contains('active') ? 'Hide Text' : 'Show Text';
            toggleContent.classList.toggle('active');
        });
        
        toggleRotation.addEventListener('click', () => {
            sceneManager.cameraController.toggleOrbit();
            toggleRotation.classList.toggle('active');
        });
        
        resetView.addEventListener('click', () => {
            sceneManager.cameraController.reset();
        });
        
        performanceBtn.addEventListener('click', () => {
            sceneManager.performanceMonitor.toggleDisplay();
            performanceBtn.classList.toggle('active');
        });
        
        // Memory node interaction
        let selectedNode = -1;
        container.addEventListener('click', (event) => {
            const rect = container.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(x, y), sceneManager.camera);
            
            // Check for memory node intersections
            const intersects = raycaster.intersectObjects(egoSphere.memoryNodes.map(n => n.node));
            
            if (intersects.length > 0) {
                const nodeIndex = egoSphere.memoryNodes.findIndex(n => n.node === intersects[0].object);
                if (nodeIndex !== -1) {
                    if (selectedNode === nodeIndex) {
                        egoSphere.resetFocus();
                        selectedNode = -1;
                    } else {
                        const position = egoSphere.focusOnMemory(nodeIndex);
                        sceneManager.cameraController.focusOn(intersects[0].object, { distance: 5 });
                        selectedNode = nodeIndex;
                    }
                }
            }
        });
        
        // Hide loading screen
        setTimeout(() => {
            const loading = document.getElementById('loading');
            loading.classList.add('fade-out');
            setTimeout(() => loading.remove(), 1000);
        }, 2000);
        
        // Handle window resize
        window.addEventListener('resize', () => {
            sceneManager.handleResize();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key.toLowerCase()) {
                case 't':
                    toggleContent.click();
                    break;
                case 'o':
                    toggleRotation.click();
                    break;
                case 'r':
                    resetView.click();
                    break;
            }
        });
    </script>
</body>
</html>