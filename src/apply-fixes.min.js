(function(){'use strict';const webglUtils=new WebGLUtils();const accessibilityUtils=new AccessibilityUtils();function enhanceWebGLCanvases(){const canvases=document.querySelectorAll('canvas');canvases.forEach(canvas=>{if(canvas.dataset.enhanced)return;if(!WebGLUtils.isWebGLSupported()){webglUtils.showFallback(canvas,new Error('WebGL not supported'));return;}canvas.addEventListener('webglcontextlost',(e)=>{e.preventDefault();});canvas.dataset.enhanced='true';});}function enhanceAccessibility(){const mainContent=document.querySelector('main,.chapter-content,#main-content');if(mainContent){mainContent.setAttribute('role','main');mainContent.id=mainContent.id||'main-content';}const nav=document.querySelector('nav');if(nav){nav.setAttribute('role','navigation');nav.id=nav.id||'navigation';nav.setAttribute('aria-label','Main navigation');}document.querySelectorAll('.visualization-container').forEach((viz,index)=>{const vizType=viz.dataset.type||'visualization';const description=accessibilityUtils.describeVisualization(vizType,{concept:viz.dataset.concept||'Jungian concepts'});accessibilityUtils.enhanceVisualization(viz,description);viz.id=viz.id||`visualization-${index}`;});const chapterCards=document.querySelectorAll('.chapter-card');if(chapterCards.length>0){accessibilityUtils.enableKeyboardNavigation(document.querySelector('.chapter-grid'),chapterCards,{role:'link',onActivate:(card)=>{const link=card.querySelector('a');if(link)link.click();}});}accessibilityUtils.addKeyboardHelp(document.body);}function fixConsoleErrors(){const originalGetContext=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=function(type,attributes){try{return originalGetContext.call(this,type,attributes);}catch(error){return null;}};if(!document.querySelector('link[rel="icon"]')){const favicon=document.createElement('link');favicon.rel='icon';favicon.type='image/svg+xml';favicon.href='data:image/svg+xml,<svg xmlns="http:document.head.appendChild(favicon);}window.addEventListener('error',(e)=>{if(e.filename&&e.filename.includes('transitions.js')){e.preventDefault();window.transitions={fadeIn:(element)=>{element.style.opacity='0';element.style.transition='opacity 0.5s ease';setTimeout(()=>element.style.opacity='1',10);}};}});}function applyResponsiveFixes(){if(!document.querySelector('meta[name="viewport"]')){const viewport=document.createElement('meta');viewport.name='viewport';viewport.content='width=device-width,initial-scale=1.0,viewport-fit=cover';document.head.appendChild(viewport);}const responsiveLink=document.createElement('link');responsiveLink.rel='stylesheet';responsiveLink.href='responsive-utils.css';document.head.appendChild(responsiveLink);function resizeCanvases(){document.querySelectorAll('canvas').forEach(canvas=>{if(canvas.id==='bg-canvas')return;const container=canvas.parentElement;if(container){const rect=container.getBoundingClientRect();if(canvas.width!==rect.width||canvas.height!==rect.height){canvas.width=rect.width;canvas.height=rect.height;if(window.THREE&&canvas.renderer){canvas.renderer.setSize(rect.width,rect.height);}}}});}let resizeTimeout;window.addEventListener('resize',()=>{clearTimeout(resizeTimeout);resizeTimeout=setTimeout(resizeCanvases,250);});resizeCanvases();if('ontouchstart' in window){document.body.classList.add('touch-device');document.querySelectorAll('button,a,.clickable').forEach(element=>{element.addEventListener('touchstart',function(){this.classList.add('touch-active');});element.addEventListener('touchend',function(){setTimeout(()=>this.classList.remove('touch-active'),150);});});}}function addLoadingStates(){if(window.VisualizationLoader){const loader=new VisualizationLoader();document.querySelectorAll('.visualization-container').forEach(container=>{if(container.children.length>0)return;const loadingState=loader.createLoadingState(container);const observer=new MutationObserver((mutations)=>{if(container.children.length>1){if(loadingState&&loadingState.parentNode){loadingState.remove();}observer.disconnect();}});observer.observe(container,{childList:true});});}}function initProgressTracking(){const match=window.location.pathname.match(/chapter(\d+)/);if(match){const chapterNumber=parseInt(match[1]);if(window.progressTracker){window.progressTracker.startChapter(chapterNumber);document.querySelectorAll('.visualization-container').forEach((viz,index)=>{viz.addEventListener('click',()=>{window.progressTracker.trackVisualization(chapterNumber,`viz-${index}`);});});const navigation=document.querySelector('.button-group,.navigation,div:has(>.button)');if(navigation&&!document.querySelector('.complete-chapter-btn')){const completeBtn=document.createElement('button');completeBtn.className='button complete-chapter-btn';completeBtn.textContent='Mark Chapter Complete ✓';completeBtn.addEventListener('click',()=>{window.progressTracker.completeChapter(chapterNumber);completeBtn.textContent='Chapter Completed ✓';completeBtn.disabled=true;});const progress=window.progressTracker.getChapterProgress(chapterNumber);if(progress&&progress.completed){completeBtn.textContent='Chapter Completed ✓';completeBtn.disabled=true;}navigation.appendChild(completeBtn);}}}}function applyPerformanceOptimizations(){document.querySelectorAll('.visualization-container').forEach(container=>{container.style.contain='layout style paint';});const images=document.querySelectorAll('img[data-src]');if('IntersectionObserver' in window){const imageObserver=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.removeAttribute('data-src');imageObserver.unobserve(img);}});});images.forEach(img=>imageObserver.observe(img));}if(navigator.hardwareConcurrency&&navigator.hardwareConcurrency<=2){document.body.classList.add('low-performance-mode');}}function init(){enhanceWebGLCanvases();enhanceAccessibility();fixConsoleErrors();applyResponsiveFixes();addLoadingStates();initProgressTracking();applyPerformanceOptimizations();if(window.AccessibilityUtils){const announcer=new AccessibilityUtils();announcer.announce('Page enhancements loaded');}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}window.aionFixes={webglUtils,accessibilityUtils,reapplyFixes:init};})();