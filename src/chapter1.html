<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Performance Optimization -->
    <script>
      // Early performance hints
      if ('connection' in navigator) {
        const connection = navigator.connection;
        if (connection.saveData || connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
          document.documentElement.classList.add('reduced-data-mode');
        }
      }
      
      // Preload critical resources
      const criticalResources = [
        '/assets/css/main.css',
        '/assets/js/core/github-pages-router.js'
      ];
      
      criticalResources.forEach(resource => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.href = resource;
        link.as = resource.endsWith('.css') ? 'style' : 'script';
        document.head.appendChild(link);
      });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 1: The Ego - Aion Visualization</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="./styles/tokens.css">
    <link rel="stylesheet" href="./styles/shared-components.css">
    <!-- Phase 3 Enhancements -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="visualization-loader.js"></script>
    <script type="module" src="lazy-visualizations.js"></script>

    <!-- Phase 4: Polish Features -->
    <link rel="preload" href="/src/components/loading-states.js" as="script" type="module">
    <link rel="preload" href="/src/components/error-boundaries.js" as="script" type="module">
    <link rel="preload" href="/src/components/micro-interactions.js" as="script" type="module">
    
    <!-- Initialize Polish Features -->
    <script type="module">
      import polishIntegration from '/src/polish-integration.js';
      
      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          console.log('Initializing polish features...');
        });
      }
    </script>
</head>
<body>

    <!-- Global Loading Container -->
    <div id="global-loader" class="loading-container"></div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="./index.html" class="nav-link">Home</a>
            <a href="chapters/index.html" class="nav-link" data-transition="chapter">Chapters</a>
            <a href="src/timeline.html" class="nav-link">Timeline</a>
            <a href="src/symbols.html" class="nav-link">Symbols</a>
            <a href="src/about.html" class="nav-link">About</a>
        </div>
    </nav>
    
    <!-- Chapter Hero -->
    <section class="chapter-hero chapter-shell-hero-gradient">
        <div class="chapter-hero-content">
            <span class="chapter-number">Chapter 01</span>
            <h1 class="chapter-shell-title">
                The Ego
            </h1>
            <p class="chapter-shell-subtitle">
                The center of consciousness
            </p>
        </div>
    </section>
    
    <!-- Content -->
    <section class="chapter-content">
        <div class="container">
            <div class="content-block">
                <p class="quote">
                    "The ego is the subject of all personal acts of consciousness."
                    <span class="author">— C.G. Jung</span>
                </p>
            </div>
            
            <div class="content-block">
                <h2 class="content-heading-lg">
                    Understanding the Ego
                </h2>
                <p>
                    In Jung's psychology, the ego represents the center of consciousness—the "I" 
                    that we identify with in our daily lives. It is the organizing principle of 
                    the conscious mind, responsible for our sense of identity and continuity.
                </p>
                <p class="content-block-offset">
                    The ego emerges from the Self, serving as a necessary focal point for 
                    consciousness, yet it represents only a small portion of the total psyche.
                </p>
            </div>
            
            <div class="content-block">
                <h3 class="content-heading-md">
                    The Ego-Self Axis
                </h3>
                <div class="visualization-container" data-error-boundary="true">
                    <canvas id="ego-self-axis"></canvas>
                </div>
                <p class="checkpoint-block">
                    The relationship between ego and Self forms the central axis of psychological 
                    development. While the ego provides necessary boundaries and identity, it must 
                    remain connected to the greater Self to maintain psychological health.
                </p>
            </div>
            
            <div class="content-block">
                <h3 class="content-heading-md">
                    Functions of the Ego
                </h3>
                <div class="grid grid-cols-2 concept-grid">
                    <div class="card concept-card">
                        <h4 class="concept-card-title">Identity</h4>
                        <p class="concept-card-body">
                            Maintains continuity of the self across time and experience
                        </p>
                    </div>
                    <div class="card concept-card">
                        <h4 class="concept-card-title">Reality Testing</h4>
                        <p class="concept-card-body">
                            Distinguishes between inner and outer reality
                        </p>
                    </div>
                    <div class="card concept-card">
                        <h4 class="concept-card-title">Defense</h4>
                        <p class="concept-card-body">
                            Protects consciousness from overwhelming content
                        </p>
                    </div>
                    <div class="card concept-card">
                        <h4 class="concept-card-title">Executive Function</h4>
                        <p class="concept-card-body">
                            Directs conscious will and decision-making
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="viz-control-dock">
                <a href="chapters/index.html" class="button" data-transition="chapter">← Back to Chapters</a>
                <a href="chapter2.html" class="button" data-transition="chapter">Chapter 2: The Shadow →</a>
            </div>
        </div>
    </section>
    
    <!-- Ego Visualization Shader -->
    <script>
        // Initialize visualization loader
        const vizLoader = new VisualizationLoader();
        
        // Ego-Self Axis Visualization
        vizLoader.lazyLoad('ego-self-axis', function(container) {
            const canvas = document.getElementById('ego-self-axis');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(
                50, 
                canvas.parentElement.offsetWidth / canvas.parentElement.offsetHeight, 
                0.1, 
                1000
            );
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            
            renderer.setSize(canvas.parentElement.offsetWidth, canvas.parentElement.offsetHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0);
            camera.position.set(0, 0, 5);
            
            // Create ego sphere
            const egoGeometry = new THREE.SphereGeometry(0.3, 32, 32);
            const egoMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            const egoSphere = new THREE.Mesh(egoGeometry, egoMaterial);
            egoSphere.position.x = -2;
            scene.add(egoSphere);
            
            // Create Self mandala
            const selfGroup = new THREE.Group();
            
            // Outer ring
            const ringGeometry = new THREE.TorusGeometry(0.5, 0.02, 16, 100);
            const ringMaterial = new THREE.MeshBasicMaterial({ color: 0x6B46C1 });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            selfGroup.add(ring);
            
            // Inner square
            const squareGeometry = new THREE.PlaneGeometry(0.7, 0.7);
            const squareEdges = new THREE.EdgesGeometry(squareGeometry);
            const squareLine = new THREE.LineSegments(
                squareEdges,
                new THREE.LineBasicMaterial({ color: 0x6B46C1 })
            );
            squareLine.rotation.z = Math.PI / 4;
            selfGroup.add(squareLine);
            
            // Center
            const centerGeometry = new THREE.SphereGeometry(0.1, 32, 32);
            const centerMaterial = new THREE.MeshBasicMaterial({ color: 0x6B46C1 });
            const center = new THREE.Mesh(centerGeometry, centerMaterial);
            selfGroup.add(center);
            
            selfGroup.position.x = 2;
            scene.add(selfGroup);
            
            // Connection line
            const points = [];
            for (let i = 0; i <= 100; i++) {
                const x = -2 + (4 * i / 100);
                const y = Math.sin(i * 0.1) * 0.1;
                points.push(new THREE.Vector3(x, y, 0));
            }
            
            const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const lineMaterial = new THREE.LineBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.3
            });
            const connectionLine = new THREE.Line(lineGeometry, lineMaterial);
            scene.add(connectionLine);
            
            // Animation
            function animate() {
                requestAnimationFrame(animate);
                
                // Rotate Self mandala
                selfGroup.rotation.z += 0.01;
                
                // Pulse ego
                const scale = 1 + Math.sin(Date.now() * 0.002) * 0.1;
                egoSphere.scale.set(scale, scale, scale);
                
                // Update connection line
                const positions = connectionLine.geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i + 1] = Math.sin((i / 3) * 0.1 + Date.now() * 0.001) * 0.1;
                }
                connectionLine.geometry.attributes.position.needsUpdate = true;
                
                renderer.render(scene, camera);
            }
            
            // Handle resize
            window.addEventListener('resize', () => {
                const width = canvas.parentElement.offsetWidth;
                const height = canvas.parentElement.offsetHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
            
            animate();
        });
        
        // Scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -10% 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);
        
        document.querySelectorAll('.content-block').forEach(block => {
            observer.observe(block);
        });
    </script>
    <script src="assets/js/core/utilities.js"></script>
    
    <!-- Phase 3 Scripts -->
    <script src="js/advanced-animations.js"></script>
    <script src="js/gesture-controller.js"></script>
    <script src="js/contextual-help.js"></script>
    <script src="js/keyboard-shortcuts.js"></script>
    <script src="js/smart-asset-loader.js"></script>
    <script src="js/adaptive-quality.js"></script>
    <script src="js/learning-analytics.js"></script>
    <script src="js/production-error-handler.js"></script>
    
    <script>
    // Initialize Phase 3 features
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize production error handler
        window.errorHandler = new ProductionErrorHandler();
        
        // Initialize adaptive quality
        window.adaptiveQuality = new AdaptiveQuality();
        
        // Initialize gesture controller for touch devices
        if ('ontouchstart' in window) {
            window.gestureController = new GestureController(document.body);
        }
        
        // Initialize keyboard shortcuts
        window.keyboardShortcuts = new KeyboardShortcuts();
        
        // Initialize contextual help
        window.contextualHelp = new ContextualHelp();
        
        // Initialize advanced animations
        window.advancedAnimations = new AdvancedAnimations();
        
        // Initialize smart asset loader
        window.assetLoader = new SmartAssetLoader();
        
        // Initialize learning analytics
        window.learningAnalytics = new LearningAnalytics();
        
        // Track page view
        if (window.learningAnalytics) {
            window.learningAnalytics.trackPageView();
        }
    });
    </script>
    <script src="personalization.js"></script>
</body>
</html>