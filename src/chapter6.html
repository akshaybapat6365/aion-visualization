<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Performance Optimization -->
    <script>
      // Early performance hints
      if ('connection' in navigator) {
        const connection = navigator.connection;
        if (connection.saveData || connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
          document.documentElement.classList.add('reduced-data-mode');
        }
      }
      
      // Preload critical resources
      const criticalResources = [
        '/assets/css/main.css',
        '/assets/js/core/github-pages-router.js'
      ];
      
      criticalResources.forEach(resource => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.href = resource;
        link.as = resource.endsWith('.css') ? 'style' : 'script';
        document.head.appendChild(link);
      });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 6: Shadow Projections - Aion by Carl Jung</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="responsive-utils.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="webgl-utils.js"></script>
    <script src="error-boundaries.js"></script>
    <script src="accessibility-utils.js"></script>
    <script src="progress-tracker.js"></script>
    <script src="visualization-loader.js"></script>
    <script src="apply-fixes.js" defer></script>

    <!-- Phase 4: Polish Features -->
    <link rel="preload" href="/src/components/loading-states.js" as="script" type="module">
    <link rel="preload" href="/src/components/error-boundaries.js" as="script" type="module">
    <link rel="preload" href="/src/components/micro-interactions.js" as="script" type="module">
    
    <!-- Initialize Polish Features -->
    <script type="module">
      import polishIntegration from '/src/polish-integration.js';
      
      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          console.log('Initializing polish features...');
        });
      }
    </script>
    <link rel="stylesheet" href="core/app-shell/app-shell.css">
    <script type="module" src="core/app-shell/app-shell.js"></script>
</head>
<body>

    <!-- Global Loading Container -->
    <div id="global-loader" class="loading-container"></div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="./index.html" class="nav-link">Home</a>
            <a href="chapters/index.html" class="nav-link" data-transition="chapter">Chapters</a>
            <a href="src/timeline.html" class="nav-link">Timeline</a>
            <a href="src/symbols.html" class="nav-link">Symbols</a>
            <a href="src/about.html" class="nav-link">About</a>
        </div>
    </nav>

    <main class="chapter-content">
        <div class="chapter-header">
            <div class="chapter-number">Chapter VI</div>
            <h1 class="chapter-title">Shadow Projections</h1>
            <p class="chapter-subtitle">Interactive Map of Collective Shadow Manifestations</p>
        </div>

        <section class="chapter-intro">
            <p>Jung's concept of shadow projection explains how individuals and societies disown their dark aspects and project them onto others. This chapter explores the collective shadow through historical events, showing how repressed content manifests in wars, persecution, and scapegoating.</p>
        </section>

        <!-- Interactive World Map of Shadow Projections -->
        <section class="visualization-section">
            <h2>Global Shadow Projection Map</h2>
            <div class="visualization-intro" data-error-boundary="true">
                <p>Explore historical events through the lens of shadow projection. See how collective shadows have manifested across time and geography, creating patterns of conflict and scapegoating.</p>
            </div>
            <div id="shadow-map" class="visualization-container" data-error-boundary="true"></div>
            <div class="map-controls">
                <div class="control-group">
                    <label for="time-period">Time Period:</label>
                    <select id="time-period">
                        <option value="ancient">Ancient (500 BCE - 500 CE)</option>
                        <option value="medieval">Medieval (500 - 1500 CE)</option>
                        <option value="early-modern">Early Modern (1500 - 1800)</option>
                        <option value="modern" selected>Modern (1800 - 1950)</option>
                        <option value="contemporary">Contemporary (1950 - Present)</option>
                        <option value="all">All Periods</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="projection-type">Projection Type:</label>
                    <select id="projection-type">
                        <option value="all" selected>All Types</option>
                        <option value="religious">Religious Persecution</option>
                        <option value="racial">Racial Scapegoating</option>
                        <option value="political">Political Enemies</option>
                        <option value="cultural">Cultural Othering</option>
                        <option value="gender">Gender Oppression</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="play-timeline">Play Historical Timeline</button>
                    <button id="show-connections">Show Projection Patterns</button>
                    <button id="analyze-region">Analyze Selected Region</button>
                </div>
            </div>
        </section>

        <!-- Shadow Integration Simulator -->
        <section class="visualization-section">
            <h2>Personal Shadow Integration Simulator</h2>
            <div class="visualization-intro" data-error-boundary="true">
                <p>Practice identifying and integrating shadow projections. This exercise helps you recognize when you might be projecting your own disowned qualities onto others.</p>
            </div>
            <div id="shadow-simulator" class="visualization-container" data-error-boundary="true">
                <div class="simulator-workspace">
                    <div class="person-profile">
                        <h3>Person A (You)</h3>
                        <div class="trait-list" id="person-a-traits">
                            <div class="trait-category">
                                <h4>Conscious Traits</h4>
                                <div class="trait-items" id="conscious-traits"></div>
                            </div>
                            <div class="trait-category">
                                <h4>Shadow Traits (Hidden)</h4>
                                <div class="trait-items" id="shadow-traits"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="projection-arrow">
                        <div class="arrow-graphic">→</div>
                        <div class="projection-energy" id="projection-strength"></div>
                        <p>Projection Intensity</p>
                    </div>
                    
                    <div class="person-profile">
                        <h3>Person B (Other)</h3>
                        <div class="trait-list" id="person-b-traits">
                            <div class="trait-category">
                                <h4>Perceived Traits</h4>
                                <div class="trait-items" id="perceived-traits"></div>
                            </div>
                            <div class="trait-category">
                                <h4>Actual Traits</h4>
                                <div class="trait-items" id="actual-traits"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="integration-panel">
                    <h3>Shadow Integration Process</h3>
                    <div class="integration-steps">
                        <div class="step" id="step-1">
                            <h4>1. Recognition</h4>
                            <p>Notice strong emotional reactions to others</p>
                            <button id="recognize-projection">Recognize Projection</button>
                        </div>
                        <div class="step" id="step-2">
                            <h4>2. Ownership</h4>
                            <p>Ask: "How might this trait apply to me?"</p>
                            <button id="own-shadow">Own the Shadow</button>
                        </div>
                        <div class="step" id="step-3">
                            <h4>3. Integration</h4>
                            <p>Consciously accept and integrate the trait</p>
                            <button id="integrate-shadow">Integrate Shadow</button>
                        </div>
                    </div>
                    <div class="integration-result" id="integration-feedback"></div>
                </div>
            </div>
            <div class="simulator-controls">
                <button id="new-scenario">New Scenario</button>
                <button id="show-analysis">Show Psychological Analysis</button>
                <button id="practice-mode">Practice Mode</button>
            </div>
        </section>

        <!-- Historical Shadow Timeline -->
        <section class="visualization-section">
            <h2>Timeline of Collective Shadow Events</h2>
            <div class="visualization-intro" data-error-boundary="true">
                <p>Follow the historical progression of major shadow projection events. See how patterns repeat across cultures and centuries.</p>
            </div>
            <div id="shadow-timeline" class="visualization-container" data-error-boundary="true"></div>
            <div class="timeline-controls">
                <button id="play-history">Play Timeline</button>
                <button id="focus-persecution">Focus on Persecution</button>
                <button id="focus-scapegoating">Focus on Scapegoating</button>
                <button id="show-patterns">Reveal Patterns</button>
            </div>
        </section>

        <!-- Educational Content -->
        <section class="content-section">
            <h2>Understanding Shadow Projection</h2>
            <div class="concept-grid">
                <div class="concept-card">
                    <h3>Personal Shadow</h3>
                    <p>Individual repressed qualities that we refuse to acknowledge in ourselves, instead seeing them clearly in others.</p>
                    <ul>
                        <li>Disowned personality traits</li>
                        <li>Repressed emotions and impulses</li>
                        <li>Unlived potential</li>
                        <li>Moral blind spots</li>
                    </ul>
                </div>
                
                <div class="concept-card">
                    <h3>Collective Shadow</h3>
                    <p>Shared cultural repressions that entire societies project onto other groups, leading to systemic oppression and conflict.</p>
                    <ul>
                        <li>Cultural taboos and repressions</li>
                        <li>Historical guilt and shame</li>
                        <li>Collective moral failures</li>
                        <li>Societal blind spots</li>
                    </ul>
                </div>
                
                <div class="concept-card">
                    <h3>Projection Mechanisms</h3>
                    <p>The psychological processes by which we unconsciously attribute our disowned qualities to others.</p>
                    <ul>
                        <li>Emotional charge and strong reactions</li>
                        <li>Black-and-white thinking</li>
                        <li>Scapegoating and blame</li>
                        <li>Demonization of the "other"</li>
                    </ul>
                </div>
                
                <div class="concept-card">
                    <h3>Integration Process</h3>
                    <p>The work of recognizing, owning, and consciously integrating shadow material to achieve psychological wholeness.</p>
                    <ul>
                        <li>Self-awareness and honest reflection</li>
                        <li>Withdrawing projections</li>
                        <li>Accepting paradox and complexity</li>
                        <li>Developing compassion</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Jung Quotes -->
        <section class="content-section">
            <h2>Jung on Shadow and Projection</h2>
            <div class="quotes-container">
                <blockquote class="jung-quote">
                    <p>"Everything that irritates us about others can lead us to an understanding of ourselves."</p>
                    <cite>— Carl Jung</cite>
                </blockquote>
                
                <blockquote class="jung-quote">
                    <p>"How can I be substantial if I do not cast a shadow? I must have a dark side also if I am to be whole."</p>
                    <cite>— Carl Jung</cite>
                </blockquote>
                
                <blockquote class="jung-quote">
                    <p>"The meeting with oneself is, at first, the meeting with one's own shadow."</p>
                    <cite>— Carl Jung</cite>
                </blockquote>
                
                <blockquote class="jung-quote">
                    <p>"Projections change the world into the replica of one's own unknown face."</p>
                    <cite>— Carl Jung</cite>
                </blockquote>
            </div>
        </section>
    </main>

    <style>
        .shadow-map-container {
            height: 500px;
            background: linear-gradient(135deg, rgba(31, 31, 31, 0.1) 0%, rgba(107, 70, 193, 0.1) 100%);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }

        .map-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--surface-glass);
            border-radius: 0.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .control-group select {
            padding: 0.5rem;
            background: var(--surface-secondary);
            border: 1px solid var(--border-default);
            border-radius: 0.25rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .control-group button {
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .control-group button:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .simulator-workspace {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            padding: 2rem;
            background: var(--surface-glass);
            border-radius: 1rem;
            min-height: 300px;
            align-items: center;
        }

        .person-profile {
            background: var(--surface-secondary);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-default);
        }

        .person-profile h3 {
            color: var(--accent);
            margin-bottom: 1rem;
            text-align: center;
        }

        .trait-category {
            margin-bottom: 1.5rem;
        }

        .trait-category h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .trait-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .trait-item {
            padding: 0.25rem 0.5rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-primary);
        }

        .trait-item.shadow {
            background: rgba(31, 31, 31, 0.8);
            border-color: #333;
            color: #999;
        }

        .trait-item.projected {
            background: var(--accent);
            color: white;
            animation: pulse 2s infinite;
        }

        .projection-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .arrow-graphic {
            font-size: 3rem;
            color: var(--accent);
            animation: pulse 2s infinite;
        }

        .projection-energy {
            width: 4px;
            height: 50px;
            background: linear-gradient(to bottom, var(--accent), transparent);
            border-radius: 2px;
        }

        .integration-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--surface-secondary);
            border-radius: 0.5rem;
            border: 1px solid var(--border-default);
        }

        .integration-panel h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .integration-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .step {
            padding: 1rem;
            background: var(--surface-glass);
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: var(--accent);
            background: rgba(107, 70, 193, 0.1);
        }

        .step h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .step p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .step button {
            padding: 0.5rem 1rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            border-radius: 0.25rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .step button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .step button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .integration-result {
            padding: 1rem;
            background: var(--surface-glass);
            border-radius: 0.25rem;
            border-left: 3px solid var(--accent);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .simulator-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .simulator-controls button {
            padding: 0.75rem 1.5rem;
            background: var(--surface-glass);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .simulator-controls button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .timeline-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .timeline-controls button {
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .timeline-controls button:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .simulator-workspace {
                grid-template-columns: 1fr;
                gap: 1rem;
                text-align: center;
            }

            .projection-arrow {
                transform: rotate(90deg);
            }

            .integration-steps {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .map-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Enhanced Chapter 6: Shadow Projections Implementation
        document.addEventListener('DOMContentLoaded', () => {
            initializeShadowMap();
            initializeShadowSimulator();
            initializeShadowTimeline();
        });

        function initializeShadowMap() {
            const container = document.getElementById('shadow-map');
            if (!container) return;

            const width = container.offsetWidth;
            const height = 500;

            // Create SVG map
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Add accessibility
            svg.attr('role', 'img')
               .attr('aria-label', 'Interactive world map showing historical shadow projection events')
               .attr('tabindex', '0');

            // Historical shadow projection data
            const shadowEvents = [
                { name: "Witch Hunts", year: 1450, lat: 52, lon: 5, type: "religious", intensity: 0.8, description: "European witch trials projected feminine shadow" },
                { name: "Spanish Inquisition", year: 1478, lat: 40, lon: -4, type: "religious", intensity: 0.9, description: "Religious persecution of 'heretics' and Jews" },
                { name: "Salem Witch Trials", year: 1692, lat: 42.5, lon: -70.9, type: "religious", intensity: 0.7, description: "Puritan shadow projection onto accused witches" },
                { name: "Pogroms", year: 1881, lat: 50, lon: 30, type: "racial", intensity: 0.8, description: "Anti-Jewish violence in Russian Empire" },
                { name: "Armenian Genocide", year: 1915, lat: 40, lon: 44, type: "racial", intensity: 1.0, description: "Ottoman projection of national insecurity" },
                { name: "Holocaust", year: 1933, lat: 52, lon: 13, type: "racial", intensity: 1.0, description: "Nazi projection of collective German shadow" },
                { name: "McCarthyism", year: 1950, lat: 39, lon: -77, type: "political", intensity: 0.6, description: "American fear projection onto communists" },
                { name: "Cultural Revolution", year: 1966, lat: 39.9, lon: 116.4, type: "political", intensity: 0.9, description: "Chinese projection onto 'bourgeois elements'" },
                { name: "Rwandan Genocide", year: 1994, lat: -1.9, lon: 30.1, type: "racial", intensity: 1.0, description: "Ethnic shadow projection and scapegoating" }
            ];

            // Map projection
            const projection = d3.geoNaturalEarth1()
                .scale(width / 6.5)
                .translate([width / 2, height / 2]);

            // Add world map outline
            svg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .attr("fill", "#0a0a0a");

            // Draw basic world outline
            const pathGenerator = d3.geoPath().projection(projection);
            
            // Simplified world geometry (you would normally load from topojson)
            svg.append("g")
                .selectAll("path")
                .data([{type: "Sphere"}])
                .enter().append("path")
                .attr("d", pathGenerator)
                .attr("fill", "none")
                .attr("stroke", "#333")
                .attr("stroke-width", 1);

            // Add event markers
            function updateMap(timePeriod = 'all', projectionType = 'all') {
                const filteredEvents = shadowEvents.filter(event => {
                    const yearFilter = timePeriod === 'all' || 
                        (timePeriod === 'ancient' && event.year < 500) ||
                        (timePeriod === 'medieval' && event.year >= 500 && event.year < 1500) ||
                        (timePeriod === 'early-modern' && event.year >= 1500 && event.year < 1800) ||
                        (timePeriod === 'modern' && event.year >= 1800 && event.year < 1950) ||
                        (timePeriod === 'contemporary' && event.year >= 1950);
                    
                    const typeFilter = projectionType === 'all' || event.type === projectionType;
                    
                    return yearFilter && typeFilter;
                });

                // Remove existing markers
                svg.selectAll('.shadow-event').remove();

                // Add new markers
                svg.selectAll('.shadow-event')
                    .data(filteredEvents)
                    .enter().append('circle')
                    .attr('class', 'shadow-event')
                    .attr('cx', d => projection([d.lon, d.lat])[0])
                    .attr('cy', d => projection([d.lon, d.lat])[1])
                    .attr('r', d => d.intensity * 15)
                    .attr('fill', d => {
                        const colors = {
                            religious: '#DC143C',
                            racial: '#8B0000',
                            political: '#4169E1',
                            cultural: '#9932CC',
                            gender: '#FF1493'
                        };
                        return colors[d.type] || '#666';
                    })
                    .attr('opacity', 0.7)
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1)
                    .on('mouseover', function(event, d) {
                        // Tooltip
                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'map-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(0,0,0,0.9)')
                            .style('color', 'white')
                            .style('padding', '10px')
                            .style('border-radius', '5px')
                            .style('pointer-events', 'none')
                            .style('opacity', 0);

                        tooltip.transition().duration(200).style('opacity', 1);
                        tooltip.html(`<strong>${d.name}</strong><br/>${d.year}<br/>${d.description}`)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.selectAll('.map-tooltip').remove();
                    });
            }

            // Initial map load
            updateMap();

            // Control handlers
            document.getElementById('time-period').addEventListener('change', (e) => {
                const projectionType = document.getElementById('projection-type').value;
                updateMap(e.target.value, projectionType);
            });

            document.getElementById('projection-type').addEventListener('change', (e) => {
                const timePeriod = document.getElementById('time-period').value;
                updateMap(timePeriod, e.target.value);
            });

            document.getElementById('play-timeline').addEventListener('click', () => {
                playHistoricalTimeline();
            });

            function playHistoricalTimeline() {
                const periods = ['ancient', 'medieval', 'early-modern', 'modern', 'contemporary'];
                let currentIndex = 0;
                
                const interval = setInterval(() => {
                    document.getElementById('time-period').value = periods[currentIndex];
                    updateMap(periods[currentIndex], 'all');
                    currentIndex++;
                    
                    if (currentIndex >= periods.length) {
                        clearInterval(interval);
                        document.getElementById('time-period').value = 'all';
                        updateMap('all', 'all');
                    }
                }, 2000);
            }
        }

        function initializeShadowSimulator() {
            const scenarios = [
                {
                    conscious: ['Kind', 'Helpful', 'Organized', 'Polite'],
                    shadow: ['Angry', 'Selfish', 'Chaotic', 'Rude'],
                    projected: ['Angry', 'Selfish'],
                    perceived: ['Always angry', 'Very selfish', 'Inconsiderate'],
                    actual: ['Sometimes frustrated', 'Independent', 'Direct communicator']
                },
                {
                    conscious: ['Rational', 'Controlled', 'Professional', 'Logical'],
                    shadow: ['Emotional', 'Wild', 'Unprofessional', 'Intuitive'],
                    projected: ['Emotional', 'Wild'],
                    perceived: ['Too emotional', 'Unpredictable', 'Unreliable'],
                    actual: ['Passionate', 'Creative', 'Authentic']
                },
                {
                    conscious: ['Moral', 'Pure', 'Good', 'Righteous'],
                    shadow: ['Immoral', 'Dirty', 'Bad', 'Sinful'],
                    projected: ['Immoral', 'Bad'],
                    perceived: ['Corrupt', 'Evil', 'Dangerous'],
                    actual: ['Human', 'Complex', 'Flawed like everyone']
                }
            ];

            let currentScenario = 0;
            let integrationStep = 0;

            function loadScenario(index) {
                const scenario = scenarios[index];
                
                // Clear existing traits
                document.getElementById('conscious-traits').innerHTML = '';
                document.getElementById('shadow-traits').innerHTML = '';
                document.getElementById('perceived-traits').innerHTML = '';
                document.getElementById('actual-traits').innerHTML = '';

                // Load conscious traits
                scenario.conscious.forEach(trait => {
                    const traitEl = document.createElement('div');
                    traitEl.className = 'trait-item';
                    traitEl.textContent = trait;
                    document.getElementById('conscious-traits').appendChild(traitEl);
                });

                // Load shadow traits (initially hidden)
                scenario.shadow.forEach(trait => {
                    const traitEl = document.createElement('div');
                    traitEl.className = 'trait-item shadow';
                    traitEl.textContent = trait;
                    document.getElementById('shadow-traits').appendChild(traitEl);
                });

                // Load perceived traits (projections)
                scenario.perceived.forEach(trait => {
                    const traitEl = document.createElement('div');
                    traitEl.className = 'trait-item projected';
                    traitEl.textContent = trait;
                    document.getElementById('perceived-traits').appendChild(traitEl);
                });

                // Load actual traits
                scenario.actual.forEach(trait => {
                    const traitEl = document.createElement('div');
                    traitEl.className = 'trait-item';
                    traitEl.textContent = trait;
                    document.getElementById('actual-traits').appendChild(traitEl);
                });

                integrationStep = 0;
                updateIntegrationSteps();
            }

            function updateIntegrationSteps() {
                document.querySelectorAll('.step').forEach((step, index) => {
                    step.classList.remove('active');
                    const button = step.querySelector('button');
                    button.disabled = index !== integrationStep;
                });

                if (integrationStep < 3) {
                    document.querySelectorAll('.step')[integrationStep].classList.add('active');
                }
            }

            // Step handlers
            document.getElementById('recognize-projection').addEventListener('click', () => {
                document.getElementById('integration-feedback').innerHTML = 
                    '<strong>Recognition:</strong> You notice that you have a strong emotional reaction to this person. This intensity often signals a projection.';
                integrationStep = 1;
                updateIntegrationSteps();
            });

            document.getElementById('own-shadow').addEventListener('click', () => {
                // Reveal shadow traits
                document.querySelectorAll('#shadow-traits .trait-item').forEach(trait => {
                    trait.classList.remove('shadow');
                });
                
                document.getElementById('integration-feedback').innerHTML = 
                    '<strong>Ownership:</strong> You recognize that the traits you dislike in them are actually disowned parts of yourself. This takes courage and honesty.';
                integrationStep = 2;
                updateIntegrationSteps();
            });

            document.getElementById('integrate-shadow').addEventListener('click', () => {
                // Transform projected traits
                document.querySelectorAll('#perceived-traits .trait-item').forEach(trait => {
                    trait.classList.remove('projected');
                    trait.style.background = 'var(--surface-glass)';
                });

                document.getElementById('integration-feedback').innerHTML = 
                    '<strong>Integration:</strong> You consciously accept these shadow aspects as part of your complete personality. The projection dissolves and you see the other person more clearly.';
                integrationStep = 3;
                updateIntegrationSteps();
            });

            // Control handlers
            document.getElementById('new-scenario').addEventListener('click', () => {
                currentScenario = (currentScenario + 1) % scenarios.length;
                loadScenario(currentScenario);
            });

            // Initialize first scenario
            loadScenario(0);
        }

        function initializeShadowTimeline() {
            const container = document.getElementById('shadow-timeline');
            if (!container) return;

            const margin = { top: 40, right: 30, bottom: 60, left: 80 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Timeline data
            const timelineData = [
                { year: -500, event: "Scapegoat Ritual", type: "religious", intensity: 0.3, description: "Ancient ritual projection" },
                { year: 30, event: "Crucifixion", type: "religious", intensity: 0.9, description: "Ultimate scapegoat sacrifice" },
                { year: 1096, event: "First Crusade", type: "religious", intensity: 0.8, description: "Christian shadow projected onto Muslims" },
                { year: 1348, event: "Black Death Blame", type: "racial", intensity: 0.7, description: "Jews blamed for plague" },
                { year: 1492, event: "Spanish Expulsion", type: "religious", intensity: 0.8, description: "Jewish expulsion from Spain" },
                { year: 1692, event: "Salem Trials", type: "religious", intensity: 0.6, description: "Witch hunt projections" },
                { year: 1881, event: "Russian Pogroms", type: "racial", intensity: 0.7, description: "Anti-Jewish violence" },
                { year: 1915, event: "Armenian Genocide", type: "racial", intensity: 1.0, description: "Ottoman ethnic cleansing" },
                { year: 1933, event: "Nazi Rise", type: "racial", intensity: 1.0, description: "Industrial scapegoating" },
                { year: 1950, event: "McCarthyism", type: "political", intensity: 0.5, description: "Red Scare projections" },
                { year: 1994, event: "Rwanda Genocide", type: "racial", intensity: 1.0, description: "Ethnic shadow explosion" },
                { year: 2001, event: "9/11 Response", type: "cultural", intensity: 0.6, description: "Religious profiling surge" }
            ];

            const xScale = d3.scaleLinear()
                .domain(d3.extent(timelineData, d => d.year))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => d > 0 ? `${d} CE` : `${Math.abs(d)} BCE`));

            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => `${d*100}%`));

            // Add axis labels
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 + margin.left/3)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .style('fill', 'var(--text-secondary)')
                .text('Shadow Projection Intensity');

            svg.append('text')
                .attr('transform', `translate(${(width + margin.left + margin.right) / 2}, ${height + margin.top + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .style('fill', 'var(--text-secondary)')
                .text('Historical Timeline');

            // Add timeline line
            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.intensity))
                .curve(d3.curveCardinal);

            g.append('path')
                .datum(timelineData)
                .attr('fill', 'none')
                .attr('stroke', '#DC143C')
                .attr('stroke-width', 2)
                .attr('d', line);

            // Add data points
            g.selectAll('.timeline-point')
                .data(timelineData)
                .enter().append('circle')
                .attr('class', 'timeline-point')
                .attr('cx', d => xScale(d.year))
                .attr('cy', d => yScale(d.intensity))
                .attr('r', 6)
                .attr('fill', d => {
                    const colors = {
                        religious: '#DC143C',
                        racial: '#8B0000',
                        political: '#4169E1',
                        cultural: '#9932CC'
                    };
                    return colors[d.type] || '#666';
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'timeline-tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0,0,0,0.9)')
                        .style('color', 'white')
                        .style('padding', '10px')
                        .style('border-radius', '5px')
                        .style('pointer-events', 'none')
                        .style('opacity', 0);

                    tooltip.transition().duration(200).style('opacity', 1);
                    tooltip.html(`<strong>${d.event}</strong><br/>${d.year > 0 ? d.year + ' CE' : Math.abs(d.year) + ' BCE'}<br/>${d.description}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.selectAll('.timeline-tooltip').remove();
                });
        }
    </script>
</body>
</html>