<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 5: Christ as Archetype - Aion by Carl Jung</title>
    <link rel="stylesheet" href="../../assets/css/bundle.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="webgl-context-manager.js"></script>
    
    <link rel="stylesheet" href="../../assets/css/chapter-shell.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="../../index.html" class="nav-link">Home</a>
            <a href="../index.html" class="nav-link">Chapters</a>
            <a href="timeline.html" class="nav-link">Timeline</a>
            <a href="symbols.html" class="nav-link">Symbols</a>
            <a href="../../src/about.html" class="nav-link">About</a>
        </div>
    </nav>

    <main class="chapter-content">
        <div class="chapter-header">
            <div class="chapter-number">Chapter V</div>
            <h1 class="chapter-title">Christ as Archetype</h1>
            <p class="chapter-subtitle">Interactive Trinity/Quaternity Mandala</p>
        </div>

        <section class="chapter-intro">
            <p>Jung's analysis of Christ as an archetypal figure reveals the psychological significance of the Christian symbol system. The tension between the trinity (three) and quaternity (four) reflects the fundamental challenge of integrating the shadow into our understanding of wholeness.</p>
        </section>

        <!-- Interactive Trinity/Quaternity Mandala -->
        <section class="visualization-section">
            <h2>Interactive Trinity/Quaternity Mandala</h2>
            <div class="visualization-intro">
                <p>Explore the psychological transformation from trinity to quaternity. Watch as the three-fold Christian symbol evolves to include the fourth element - the shadow - creating psychological wholeness.</p>
            </div>
            <div id="trinity-mandala" class="visualization-container"></div>
            <div class="visualization-controls">
                <div class="control-group">
                    <button id="show-trinity">Show Trinity</button>
                    <button id="show-quaternity">Show Quaternity</button>
                    <button id="morph-transformation">Animate Transformation</button>
                </div>
                <div class="control-group">
                    <label for="shadow-intensity">Shadow Integration:</label>
                    <input type="range" id="shadow-intensity" min="0" max="100" value="0">
                    <span id="shadow-level">Repressed</span>
                </div>
                <div class="control-group">
                    <button id="show-symbols">Toggle Symbol Labels</button>
                    <button id="show-meaning">Show Psychological Meaning</button>
                </div>
            </div>
        </section>

        <!-- Christian Symbol Timeline -->
        <section class="visualization-section">
            <h2>Evolution of Christian Symbolism</h2>
            <div class="visualization-intro">
                <p>Trace the development of Christian symbols from early Christianity through medieval theology, showing how the trinity symbol evolved and what it left out.</p>
            </div>
            <div id="symbol-timeline" class="visualization-container"></div>
            <div class="timeline-controls">
                <button id="play-timeline">Play Evolution</button>
                <button id="pause-timeline">Pause</button>
                <button id="reset-timeline">Reset</button>
                <div class="timeline-speed">
                    <label for="speed-control">Speed:</label>
                    <input type="range" id="speed-control" min="1" max="10" value="5">
                </div>
            </div>
        </section>

        <!-- Educational Content -->
        <section class="content-section">
            <h2>The Psychological Significance of Christ</h2>
            <div class="concept-grid">
                <div class="concept-card">
                    <h3>Christ as Self Symbol</h3>
                    <p>Jung viewed Christ not as a historical figure but as an archetypal representation of the Self - the totality of the psyche including both conscious and unconscious elements.</p>
                    <ul>
                        <li>Bridge between human and divine</li>
                        <li>Symbol of psychological wholeness</li>
                        <li>Integration of opposites</li>
                        <li>Individuation pathway</li>
                    </ul>
                </div>
                
                <div class="concept-card">
                    <h3>The Missing Fourth</h3>
                    <p>Traditional Christian trinity (Father, Son, Holy Spirit) excludes the shadow element - the dark, evil, or feminine principle that Jung saw as essential for psychological completeness.</p>
                    <ul>
                        <li>Devil as split-off shadow</li>
                        <li>Mary as feminine fourth</li>
                        <li>Evil as necessary opposite</li>
                        <li>Psychological vs. theological truth</li>
                    </ul>
                </div>
                
                <div class="concept-card">
                    <h3>Trinity vs. Quaternity</h3>
                    <p>The tension between three (spiritual perfection) and four (earthly completion) represents the challenge of integrating spiritual ideals with psychological reality.</p>
                    <ul>
                        <li>Three: Divine perfection, spirit</li>
                        <li>Four: Earthly completion, matter</li>
                        <li>Transformation through integration</li>
                        <li>Mandala as wholeness symbol</li>
                    </ul>
                </div>
                
                <div class="concept-card">
                    <h3>Modern Implications</h3>
                    <p>Jung's analysis suggests that modern psychology must integrate what religion has split off - acknowledging the shadow to achieve genuine wholeness.</p>
                    <ul>
                        <li>Shadow work in therapy</li>
                        <li>Integration over perfection</li>
                        <li>Authentic self-realization</li>
                        <li>Collective shadow projection</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Interactive Symbol Placement -->
        <section class="visualization-section">
            <h2>Symbol Integration Exercise</h2>
            <div class="visualization-intro">
                <p>Drag and drop symbols to create your own mandala. Explore how different arrangements affect the psychological meaning and balance.</p>
            </div>
            <div id="symbol-exercise" class="visualization-container">
                <div class="symbol-palette">
                    <h3>Available Symbols</h3>
                    <div class="symbol-items">
                        <div class="symbol-item" data-symbol="cross" draggable="true">‚úù Cross</div>
                        <div class="symbol-item" data-symbol="circle" draggable="true">‚óã Circle</div>
                        <div class="symbol-item" data-symbol="triangle" draggable="true">‚ñ≥ Trinity</div>
                        <div class="symbol-item" data-symbol="square" draggable="true">‚ñ° Quaternity</div>
                        <div class="symbol-item" data-symbol="shadow" draggable="true">‚óè Shadow</div>
                        <div class="symbol-item" data-symbol="light" draggable="true">‚òâ Light</div>
                        <div class="symbol-item" data-symbol="feminine" draggable="true">‚òΩ Feminine</div>
                        <div class="symbol-item" data-symbol="masculine" draggable="true">‚òâ Masculine</div>
                    </div>
                </div>
                <div class="mandala-workspace" id="mandala-drop-zone">
                    <div class="workspace-guide">
                        <p>Drop symbols here to create your mandala</p>
                        <div class="guide-circles">
                            <div class="inner-circle"></div>
                            <div class="middle-circle"></div>
                            <div class="outer-circle"></div>
                        </div>
                    </div>
                </div>
                <div class="mandala-analysis">
                    <h3>Psychological Analysis</h3>
                    <div id="analysis-result">
                        <p>Create a mandala to see psychological interpretation...</p>
                    </div>
                </div>
            </div>
            <div class="exercise-controls">
                <button id="clear-mandala">Clear Mandala</button>
                <button id="save-mandala">Save Creation</button>
                <button id="load-example">Load Example</button>
                <button id="analyze-balance">Analyze Balance</button>
            </div>
        </section>

        <!-- Jung Quotes Section -->
        <section class="content-section">
            <h2>Jung on Christ and the Self</h2>
            <div class="quotes-container">
                <blockquote class="jung-quote">
                    <p>"Christ is the still living myth of our culture. He is our culture hero, who, regardless of his historical existence, embodies the myth of the divine Primordial Man, the mystic Adam."</p>
                    <cite>‚Äî Carl Jung, Aion</cite>
                </blockquote>
                
                <blockquote class="jung-quote">
                    <p>"The quaternio is an archetype of almost universal occurrence. It forms the logical basis for any whole judgment. If one wishes to pass such a judgment, it must have this fourfold aspect."</p>
                    <cite>‚Äî Carl Jung, Psychology and Alchemy</cite>
                </blockquote>
                
                <blockquote class="jung-quote">
                    <p>"The Christ-symbol is of the greatest importance for psychology in so far as it is perhaps the most highly developed and differentiated symbol of the self."</p>
                    <cite>‚Äî Carl Jung, Aion</cite>
                </blockquote>
            </div>
        </section>
    </main>

    <style>
        .trinity-mandala-container {
            position: relative;
            height: 500px;
            background: radial-gradient(circle, rgba(107, 70, 193, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            margin: 2rem auto;
        }

        .symbol-timeline-container {
            height: 300px;
            background: linear-gradient(90deg, rgba(107, 70, 193, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 120px;
        }

        .control-group input[type="range"] {
            flex: 1;
            min-width: 120px;
            margin: 0 0.5rem;
        }

        .control-group button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .control-group button:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .timeline-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .timeline-speed {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .symbol-exercise {
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            gap: 2rem;
            min-height: 400px;
            padding: 1rem;
            background: var(--surface-glass);
            border-radius: 1rem;
        }

        .symbol-palette {
            background: var(--surface-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-default);
        }

        .symbol-palette h3 {
            margin-bottom: 1rem;
            color: var(--accent);
            font-size: 1rem;
        }

        .symbol-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .symbol-item {
            padding: 0.75rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 0.25rem;
            cursor: move;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            text-align: center;
        }

        .symbol-item:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.05);
        }

        .symbol-item[draggable="true"] {
            user-select: none;
        }

        .mandala-workspace {
            position: relative;
            background: radial-gradient(circle, rgba(107, 70, 193, 0.05) 0%, transparent 70%);
            border: 2px dashed var(--border-default);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .workspace-guide {
            text-align: center;
            color: var(--text-tertiary);
            position: relative;
        }

        .guide-circles {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
        }

        .guide-circles > div {
            position: absolute;
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .inner-circle {
            width: 80px;
            height: 80px;
        }

        .middle-circle {
            width: 160px;
            height: 160px;
        }

        .outer-circle {
            width: 280px;
            height: 280px;
        }

        .mandala-analysis {
            background: var(--surface-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-default);
        }

        .mandala-analysis h3 {
            margin-bottom: 1rem;
            color: var(--accent);
            font-size: 1rem;
        }

        .exercise-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .exercise-controls button {
            padding: 0.75rem 1.5rem;
            background: var(--surface-glass);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exercise-controls button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .quotes-container {
            display: grid;
            gap: 2rem;
            margin: 2rem 0;
        }

        .jung-quote {
            background: var(--surface-glass);
            padding: 2rem;
            border-radius: 1rem;
            border-left: 4px solid var(--accent);
            font-style: italic;
            position: relative;
        }

        .jung-quote p {
            font-size: 1.125rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .jung-quote cite {
            font-style: normal;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .symbol-exercise {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .timeline-controls {
                flex-direction: column;
                gap: 0.5rem;
            }

            .guide-circles {
                width: 200px;
                height: 200px;
            }

            .inner-circle {
                width: 60px;
                height: 60px;
            }

            .middle-circle {
                width: 120px;
                height: 120px;
            }

            .outer-circle {
                width: 200px;
                height: 200px;
            }
        }
    </style>

    <script>
        // Enhanced Chapter 5: Trinity/Quaternity Mandala Implementation
        document.addEventListener('DOMContentLoaded', () => {
            initializeTrinityMandala();
            initializeSymbolTimeline();
            initializeSymbolExercise();
        });

        function initializeTrinityMandala() {
            const container = document.getElementById('trinity-mandala');
            if (!container) return;

            const width = container.offsetWidth;
            const height = 500;

            // Create Three.js scene with optimized WebGL context
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            
            // Use optimized context manager
            const canvas = document.createElement('canvas');
            const gl = window.createOptimizedWebGLContext(canvas, { 
                alpha: true, 
                antialias: !window.webglContextManager.isLowMemoryDevice,
                powerPreference: 'default'
            });
            
            const renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                context: gl,
                alpha: true, 
                antialias: !window.webglContextManager.isLowMemoryDevice 
            });
            renderer.setSize(width, height);
            renderer.setClearColor(0x000000, 0);

            // Add accessibility attributes
            renderer.domElement.setAttribute('role', 'img');
            renderer.domElement.setAttribute('aria-label', 'Interactive 3D mandala showing transformation from Christian trinity to psychological quaternity');
            renderer.domElement.setAttribute('tabindex', '0');

            container.appendChild(renderer.domElement);

            // Add screen reader description
            const description = document.createElement('div');
            description.id = 'trinity-mandala-description';
            description.className = 'sr-only';
            description.innerHTML = `
                <h3>Trinity/Quaternity Mandala Description</h3>
                <p>This visualization shows the transformation from the Christian trinity (three-fold symbol) to a psychological quaternity (four-fold symbol). The trinity represents Father, Son, and Holy Spirit, while the quaternity adds the shadow or feminine element for psychological completeness.</p>
                <p>Use the controls to animate the transformation and see how integrating the shadow creates a more complete symbol of the Self.</p>
            `;
            container.appendChild(description);
            renderer.domElement.setAttribute('aria-describedby', 'trinity-mandala-description');

            camera.position.set(0, 0, 8);

            // Mandala state
            let currentState = 'trinity';
            let morphProgress = 0;
            let shadowIntensity = 0;

            // Create geometry groups
            const trinityGroup = new THREE.Group();
            const quaternityGroup = new THREE.Group();
            scene.add(trinityGroup);
            scene.add(quaternityGroup);

            // Create Trinity (triangle-based)
            function createTrinity() {
                trinityGroup.clear();

                // Central circle
                const centerGeometry = new THREE.CircleGeometry(0.3, 32);
                const centerMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xFFD700, 
                    transparent: true,
                    opacity: 0.8 
                });
                const center = new THREE.Mesh(centerGeometry, centerMaterial);
                trinityGroup.add(center);

                // Trinity points
                const points = [
                    { angle: -Math.PI/2, label: 'Father', color: 0x6B46C1 },
                    { angle: Math.PI/6, label: 'Son', color: 0x7C3AED },
                    { angle: 5*Math.PI/6, label: 'Holy Spirit', color: 0x5B21B6 }
                ];

                points.forEach((point, index) => {
                    const radius = 2.5;
                    const x = Math.cos(point.angle) * radius;
                    const y = Math.sin(point.angle) * radius;

                    // Point circle
                    const pointGeometry = new THREE.CircleGeometry(0.4, 32);
                    const pointMaterial = new THREE.MeshBasicMaterial({ 
                        color: point.color,
                        transparent: true,
                        opacity: 0.9 
                    });
                    const pointMesh = new THREE.Mesh(pointGeometry, pointMaterial);
                    pointMesh.position.set(x, y, 0);
                    trinityGroup.add(pointMesh);

                    // Connecting lines
                    const nextIndex = (index + 1) % points.length;
                    const nextPoint = points[nextIndex];
                    const nextX = Math.cos(nextPoint.angle) * radius;
                    const nextY = Math.sin(nextPoint.angle) * radius;

                    const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(x, y, 0),
                        new THREE.Vector3(nextX, nextY, 0)
                    ]);
                    const lineMaterial = new THREE.LineBasicMaterial({ 
                        color: 0xFFFFFF, 
                        transparent: true, 
                        opacity: 0.6 
                    });
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    trinityGroup.add(line);
                });
            }

            // Create Quaternity (square-based)
            function createQuaternity() {
                quaternityGroup.clear();

                // Central circle
                const centerGeometry = new THREE.CircleGeometry(0.3, 32);
                const centerMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xFFD700, 
                    transparent: true,
                    opacity: 0.8 
                });
                const center = new THREE.Mesh(centerGeometry, centerMaterial);
                quaternityGroup.add(center);

                // Quaternity points
                const points = [
                    { angle: -Math.PI/2, label: 'Spirit', color: 0x6B46C1 },
                    { angle: 0, label: 'Matter', color: 0x7C3AED },
                    { angle: Math.PI/2, label: 'Light', color: 0x5B21B6 },
                    { angle: Math.PI, label: 'Shadow', color: 0x1F1F1F }
                ];

                points.forEach((point, index) => {
                    const radius = 2.5;
                    const x = Math.cos(point.angle) * radius;
                    const y = Math.sin(point.angle) * radius;

                    // Point circle
                    const pointGeometry = new THREE.CircleGeometry(0.4, 32);
                    const pointMaterial = new THREE.MeshBasicMaterial({ 
                        color: point.color,
                        transparent: true,
                        opacity: point.label === 'Shadow' ? shadowIntensity : 0.9 
                    });
                    const pointMesh = new THREE.Mesh(pointGeometry, pointMaterial);
                    pointMesh.position.set(x, y, 0);
                    quaternityGroup.add(pointMesh);

                    // Connecting lines to form square
                    const nextIndex = (index + 1) % points.length;
                    const nextPoint = points[nextIndex];
                    const nextX = Math.cos(nextPoint.angle) * radius;
                    const nextY = Math.sin(nextPoint.angle) * radius;

                    const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(x, y, 0),
                        new THREE.Vector3(nextX, nextY, 0)
                    ]);
                    const lineMaterial = new THREE.LineBasicMaterial({ 
                        color: 0xFFFFFF, 
                        transparent: true, 
                        opacity: 0.6 
                    });
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    quaternityGroup.add(line);
                });
            }

            // Initialize with trinity
            createTrinity();
            createQuaternity();
            quaternityGroup.visible = false;

            // Animation loop
            function animate() {
                trinityGroup.rotation.z += 0.005;
                quaternityGroup.rotation.z += 0.003;
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }
            animate();

            // Control handlers
            document.getElementById('show-trinity').addEventListener('click', () => {
                trinityGroup.visible = true;
                quaternityGroup.visible = false;
                currentState = 'trinity';
            });

            document.getElementById('show-quaternity').addEventListener('click', () => {
                trinityGroup.visible = false;
                quaternityGroup.visible = true;
                currentState = 'quaternity';
            });

            document.getElementById('morph-transformation').addEventListener('click', () => {
                // Animated transformation between trinity and quaternity
                const duration = 3000;
                const startTime = Date.now();
                
                function morphAnimation() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    if (currentState === 'trinity') {
                        trinityGroup.visible = true;
                        quaternityGroup.visible = true;
                        trinityGroup.material?.forEach(mat => {
                            if (mat.opacity !== undefined) mat.opacity = 1 - progress;
                        });
                        quaternityGroup.material?.forEach(mat => {
                            if (mat.opacity !== undefined) mat.opacity = progress;
                        });
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(morphAnimation);
                    } else {
                        currentState = currentState === 'trinity' ? 'quaternity' : 'trinity';
                    }
                }
                morphAnimation();
            });

            // Shadow intensity control
            document.getElementById('shadow-intensity').addEventListener('input', (e) => {
                shadowIntensity = e.target.value / 100;
                document.getElementById('shadow-level').textContent = 
                    shadowIntensity < 0.3 ? 'Repressed' :
                    shadowIntensity < 0.7 ? 'Acknowledged' : 'Integrated';
                
                createQuaternity(); // Recreate with new shadow intensity
            });
        }

        function initializeSymbolTimeline() {
            const container = document.getElementById('symbol-timeline');
            if (!container) return;

            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 250 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Timeline data
            const timelineData = [
                { year: 30, event: 'Jesus\'s Death', symbolism: 'Cross emerges', prominence: 0.2 },
                { year: 325, event: 'Council of Nicaea', symbolism: 'Trinity doctrine', prominence: 0.6 },
                { year: 431, event: 'Council of Ephesus', symbolism: 'Mary as Theotokos', prominence: 0.4 },
                { year: 1054, event: 'Great Schism', symbolism: 'East/West split', prominence: 0.7 },
                { year: 1215, event: 'Fourth Lateran', symbolism: 'Trinity dogma', prominence: 0.9 },
                { year: 1517, event: 'Reformation', symbolism: 'Trinity questioned', prominence: 0.5 },
                { year: 1950, event: 'Marian dogma', symbolism: 'Fourth element?', prominence: 0.3 },
                { year: 2000, event: 'Modern psychology', symbolism: 'Jung\'s analysis', prominence: 0.8 }
            ];

            const xScale = d3.scaleLinear()
                .domain(d3.extent(timelineData, d => d.year))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d => `${d} CE`));

            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => `${d*100}%`));

            // Add timeline line
            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.prominence))
                .curve(d3.curveCardinal);

            g.append('path')
                .datum(timelineData)
                .attr('fill', 'none')
                .attr('stroke', '#6B46C1')
                .attr('stroke-width', 3)
                .attr('d', line);

            // Add data points
            g.selectAll('.data-point')
                .data(timelineData)
                .enter().append('circle')
                .attr('class', 'data-point')
                .attr('cx', d => xScale(d.year))
                .attr('cy', d => yScale(d.prominence))
                .attr('r', 6)
                .attr('fill', '#FFD700')
                .attr('stroke', '#6B46C1')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    // Tooltip functionality
                    const tooltip = d3.select('body').append('div')
                        .attr('class', 'tooltip')
                        .style('opacity', 0);
                    
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    tooltip.html(`<strong>${d.year} CE: ${d.event}</strong><br/>${d.symbolism}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.selectAll('.tooltip').remove();
                });
        }

        function initializeSymbolExercise() {
            const workspace = document.getElementById('mandala-drop-zone');
            const analysisResult = document.getElementById('analysis-result');
            let placedSymbols = [];

            // Drag and drop functionality
            document.querySelectorAll('.symbol-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.symbol);
                });
            });

            workspace.addEventListener('dragover', (e) => {
                e.preventDefault();
                workspace.style.borderColor = 'var(--accent)';
            });

            workspace.addEventListener('dragleave', (e) => {
                workspace.style.borderColor = 'var(--border-default)';
            });

            workspace.addEventListener('drop', (e) => {
                e.preventDefault();
                workspace.style.borderColor = 'var(--border-default)';
                
                const symbolType = e.dataTransfer.getData('text/plain');
                const rect = workspace.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                addSymbolToMandala(symbolType, x, y);
            });

            function addSymbolToMandala(symbolType, x, y) {
                const symbolElement = document.createElement('div');
                symbolElement.className = 'placed-symbol';
                symbolElement.style.position = 'absolute';
                symbolElement.style.left = `${x - 15}px`;
                symbolElement.style.top = `${y - 15}px`;
                symbolElement.style.width = '30px';
                symbolElement.style.height = '30px';
                symbolElement.style.display = 'flex';
                symbolElement.style.alignItems = 'center';
                symbolElement.style.justifyContent = 'center';
                symbolElement.style.background = 'var(--accent)';
                symbolElement.style.color = 'white';
                symbolElement.style.borderRadius = '50%';
                symbolElement.style.fontSize = '18px';
                symbolElement.style.cursor = 'pointer';
                symbolElement.style.zIndex = '10';
                
                const symbols = {
                    'cross': '‚úù',
                    'circle': '‚óã',
                    'triangle': '‚ñ≥',
                    'square': '‚ñ°',
                    'shadow': '‚óè',
                    'light': '‚òâ',
                    'feminine': '‚òΩ',
                    'masculine': '‚òâ'
                };
                
                symbolElement.textContent = symbols[symbolType] || '?';
                symbolElement.addEventListener('click', () => {
                    workspace.removeChild(symbolElement);
                    placedSymbols = placedSymbols.filter(s => s.element !== symbolElement);
                    analyzeMandala();
                });
                
                workspace.appendChild(symbolElement);
                placedSymbols.push({ type: symbolType, x, y, element: symbolElement });
                analyzeMandala();
            }

            function analyzeMandala() {
                if (placedSymbols.length === 0) {
                    analysisResult.innerHTML = '<p>Create a mandala to see psychological interpretation...</p>';
                    return;
                }

                const symbolCounts = {};
                placedSymbols.forEach(symbol => {
                    symbolCounts[symbol.type] = (symbolCounts[symbol.type] || 0) + 1;
                });

                let analysis = '<h4>Mandala Analysis:</h4>';
                
                // Check for balance
                const hasShadow = symbolCounts.shadow > 0;
                const hasLight = symbolCounts.light > 0;
                const hasFeminine = symbolCounts.feminine > 0;
                const hasMasculine = symbolCounts.masculine > 0;
                
                if (hasShadow && hasLight) {
                    analysis += '<p>‚úÖ <strong>Light/Shadow Balance:</strong> Good integration of opposites.</p>';
                } else if (hasLight && !hasShadow) {
                    analysis += '<p>‚ö†Ô∏è <strong>Missing Shadow:</strong> Consider integrating darker elements.</p>';
                }
                
                if (hasFeminine && hasMasculine) {
                    analysis += '<p>‚úÖ <strong>Gender Balance:</strong> Anima/Animus integration present.</p>';
                }
                
                // Check for sacred numbers
                const totalSymbols = placedSymbols.length;
                if (totalSymbols === 3) {
                    analysis += '<p>üî∫ <strong>Trinity Pattern:</strong> Spiritual perfection, but missing earthly completion.</p>';
                } else if (totalSymbols === 4) {
                    analysis += '<p>‚óºÔ∏è <strong>Quaternity Pattern:</strong> Psychological wholeness and completion.</p>';
                } else if (totalSymbols % 4 === 0) {
                    analysis += '<p>‚óºÔ∏è <strong>Quaternary Multiple:</strong> Strong foundation for psychological integration.</p>';
                }
                
                analysisResult.innerHTML = analysis;
            }

            // Control buttons
            document.getElementById('clear-mandala').addEventListener('click', () => {
                placedSymbols.forEach(symbol => {
                    workspace.removeChild(symbol.element);
                });
                placedSymbols = [];
                analyzeMandala();
            });

            document.getElementById('load-example').addEventListener('click', () => {
                // Clear existing
                document.getElementById('clear-mandala').click();
                
                // Add example quaternary mandala
                setTimeout(() => {
                    addSymbolToMandala('light', 150, 50);     // North
                    addSymbolToMandala('shadow', 150, 250);   // South  
                    addSymbolToMandala('masculine', 250, 150); // East
                    addSymbolToMandala('feminine', 50, 150);   // West
                    addSymbolToMandala('cross', 150, 150);     // Center
                }, 100);
            });
        }
    </script>

    <script src="../../assets/js/chapter-shell.js"></script>
</body>
</html>